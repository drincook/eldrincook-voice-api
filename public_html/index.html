<!DOCTYPE html>
<html lang="es">
  <head>
    <title>Grabadora de Voz - EldrinCook</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Todo tu CSS original se mantiene igual, solo podr√≠as agregar:
      - outline: 2px solid #007bff; para los inputs y botones :focus
      - .sr-only para accesibilidad */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }
      input:focus,
      button:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
      }
    </style>
  </head>
  <body>
    <main class="container" role="main" aria-label="Grabadora principal">
      <h1 class="text-3xl font-extrabold">üéôÔ∏è Graba tu voz para el podcast</h1>
      <form
        id="grabacionForm"
        class="input-group"
        autocomplete="off"
        onsubmit="return false;"
      >
        <label for="nombre" id="nombreLabel">üìõ Nombre de la grabaci√≥n:</label>
        <input
          type="text"
          id="nombre"
          aria-labelledby="nombreLabel"
          placeholder="ej: capitulo-intro"
          class="shadow-sm focus:ring-blue-500 focus:border-blue-500"
          autocomplete="off"
        />
      </form>

      <p id="status" class="loading" role="status" aria-live="polite">
        üîÑ Cargando servidor...
      </p>

      <div id="recording-indicator" style="display: none">
        <span id="recording-dot" aria-hidden="true"></span>
        <span id="recording-timer">00:00</span>
      </div>

      <div class="controls" role="group" aria-label="Controles de grabaci√≥n">
        <button
          id="start"
          type="button"
          disabled
          aria-label="Comenzar Grabaci√≥n"
        >
          Comenzar Grabaci√≥n
        </button>
        <button id="stop" type="button" disabled aria-label="Detener Grabaci√≥n">
          Detener
        </button>
      </div>

      <div id="audio-player-container">
        <audio
          id="audio"
          controls
          class="w-full rounded-lg"
          aria-label="Reproductor de la √∫ltima grabaci√≥n"
        ></audio>
      </div>
    </main>

    <audio
      id="success-sound"
      src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_3cf9ccf3ca.mp3"
      preload="auto"
      aria-hidden="true"
    ></audio>

    <hr />

    <section class="container mt-8" aria-labelledby="historialTitle">
      <h2 id="historialTitle" class="text-2xl font-bold">
        üïò Historial de Grabaciones
      </h2>
      <ul id="historial"></ul>
      <button
        class="borrar"
        type="button"
        onclick="showConfirmModal('¬øEst√°s seguro de que quieres borrar todo el historial?', borrarHistorialConfirm)"
        aria-label="Borrar historial de grabaciones"
      >
        üóëÔ∏è Borrar historial
      </button>
    </section>

    <div
      id="customModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modalTitle"
    >
      <div class="modal-content">
        <h3 id="modalTitle"></h3>
        <p id="modalMessage"></p>
        <div class="modal-buttons">
          <button id="modalConfirmBtn" class="confirm-btn" type="button">
            Aceptar
          </button>
          <button
            id="modalCancelBtn"
            class="cancel-btn"
            type="button"
            style="display: none"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <script>
      let mediaRecorder;
      let audioChunks = [];
      let recordingTimerInterval;
      let recordingStartTime;

      const status = document.getElementById("status");
      const startBtn = document.getElementById("start");
      const stopBtn = document.getElementById("stop");
      const inputNombre = document.getElementById("nombre");
      const successSound = document.getElementById("success-sound");
      const recordingIndicator = document.getElementById("recording-indicator");
      const recordingTimer = document.getElementById("recording-timer");

      // Modal references
      const customModal = document.getElementById("customModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalMessage = document.getElementById("modalMessage");
      const modalConfirmBtn = document.getElementById("modalConfirmBtn");
      const modalCancelBtn = document.getElementById("modalCancelBtn");

      // Modal helpers
      function showModal(
        title,
        message,
        isConfirm = false,
        onConfirm = null,
        onCancel = null
      ) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        customModal.style.display = "flex";
        modalCancelBtn.style.display = isConfirm ? "inline-block" : "none";
        modalConfirmBtn.onclick = () => {
          customModal.style.display = "none";
          if (onConfirm) onConfirm();
        };
        modalCancelBtn.onclick = isConfirm
          ? () => {
              customModal.style.display = "none";
              if (onCancel) onCancel();
            }
          : null;
      }
      function showAlert(message) {
        showModal("Atenci√≥n", message);
      }
      function showConfirmModal(message, onConfirm, onCancel = null) {
        showModal("Confirmaci√≥n", message, true, onConfirm, onCancel);
      }

      // Timer
      function updateRecordingTimer() {
        const elapsedTime = Date.now() - recordingStartTime;
        const seconds = Math.floor((elapsedTime / 1000) % 60);
        const minutes = Math.floor(elapsedTime / 1000 / 60);
        recordingTimer.textContent = `${String(minutes).padStart(
          2,
          "0"
        )}:${String(seconds).padStart(2, "0")}`;
      }

      async function pingBackend() {
        try {
          await fetch("https://eldrincook-voice-api.onrender.com/files");
          status.textContent = "‚úÖ Servidor activo. Puedes grabar tu voz.";
          status.className = "success";
          startBtn.disabled = false;
          startBtn.focus();
        } catch (err) {
          status.textContent = "‚ö†Ô∏è El servidor est√° tardando en responder...";
          status.className = "error";
          showAlert(
            "El servidor est√° tardando en responder. Por favor, int√©ntalo de nuevo m√°s tarde."
          );
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        pingBackend();
        mostrarHistorial();
      });

      // Mejor experiencia para Enter en el input
      inputNombre.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          startBtn.click();
        }
      });

      startBtn.onclick = async () => {
        try {
          // Permiso de micr√≥fono
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();

          audioChunks = [];
          mediaRecorder.ondataavailable = (event) =>
            audioChunks.push(event.data);

          // Temporizador & estados
          recordingStartTime = Date.now();
          recordingTimer.textContent = "00:00";
          recordingIndicator.style.display = "flex";
          recordingTimerInterval = setInterval(updateRecordingTimer, 1000);

          status.textContent = "üî¥ Grabando...";
          status.className = "recording";
          startBtn.disabled = true;
          stopBtn.disabled = false;
          stopBtn.focus();

          mediaRecorder.onstop = async () => {
            clearInterval(recordingTimerInterval);
            recordingIndicator.style.display = "none";

            const blob = new Blob(audioChunks, { type: "audio/webm" });
            document.getElementById("audio").src = URL.createObjectURL(blob);

            // Limpia y sanitiza el nombre
            let nombreLimpio = inputNombre.value
              .trim()
              .replace(/\s+/g, "_")
              .replace(/\.(webm|mp3)$/i, "");
            if (!nombreLimpio) nombreLimpio = `grabacion-${Date.now()}`;
            const formData = new FormData();
            formData.append("audio", blob, `${nombreLimpio}.webm`);
            formData.append("nombrePersonalizado", nombreLimpio);

            status.textContent = "‚¨ÜÔ∏è Subiendo y convirtiendo...";
            status.className = "loading";

            try {
              const response = await fetch(
                "https://eldrincook-voice-api.onrender.com/upload",
                {
                  method: "POST",
                  body: formData,
                  credentials: "include",
                }
              );
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(
                  `Error del servidor: ${response.status} - ${errorText}`
                );
              }
              const result = await response.json();
              status.innerHTML = `
                ‚úÖ Grabaci√≥n enviada como: <strong>${result.nombre}</strong><br>
                <a href="${result.googleDriveUrl}" target="_blank" class="text-blue-600 hover:underline">‚¨áÔ∏è Descargar MP3</a>
              `;
              status.className = "success";
              successSound.play();

              // Descarga autom√°tica accesible
              const a = document.createElement("a");
              a.href = result.googleDriveUrl;
              a.download = result.nombre || "grabacion.mp3";
              a.style.display = "none";
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);

              guardarEnHistorial(result.nombre, result.googleDriveUrl);
            } catch (err) {
              console.error("‚ùå Error al subir:", err);
              status.textContent = "‚ùå Error al subir la grabaci√≥n.";
              status.className = "error";
              showAlert("Hubo un error al subir tu grabaci√≥n: " + err.message);
            } finally {
              startBtn.disabled = false;
              startBtn.focus();
            }
          };
        } catch (err) {
          console.error("‚ùå Error al acceder al micr√≥fono:", err);
          status.textContent = "‚ùå Error: No se pudo acceder al micr√≥fono.";
          status.className = "error";
          showAlert(
            "No se pudo acceder al micr√≥fono. Por favor, aseg√∫rate de que los permisos est√©n concedidos."
          );
          startBtn.disabled = false;
          startBtn.focus();
        }
      };

      stopBtn.onclick = () => {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
          stopBtn.disabled = true;
          startBtn.disabled = false;
          startBtn.focus();
        }
      };

      // Historial accesible
      function guardarEnHistorial(nombre, url) {
        const historial = JSON.parse(localStorage.getItem("grabaciones")) || [];
        const nueva = {
          nombre,
          url,
          fecha: new Date().toLocaleString("es-ES"),
        };
        historial.unshift(nueva);
        localStorage.setItem("grabaciones", JSON.stringify(historial));
        mostrarHistorial();
      }
      function mostrarHistorial() {
        const historial = JSON.parse(localStorage.getItem("grabaciones")) || [];
        const lista = document.getElementById("historial");
        lista.innerHTML = "";
        if (historial.length === 0) {
          lista.innerHTML =
            '<li class="text-gray-500">A√∫n no has grabado nada.</li>';
          return;
        }
        historial.forEach((item) => {
          const li = document.createElement("li");
          li.className =
            "flex flex-col md:flex-row md:items-center justify-between gap-2";
          li.innerHTML = `
            <div class="flex-grow">
              üìÅ <strong>${item.nombre}</strong> - <span class="text-sm text-gray-600">${item.fecha}</span>
            </div>
            <div class="flex items-center gap-2 mt-2 md:mt-0">
              <audio controls src="${item.url}" class="w-full md:w-auto h-8"></audio>
              <a href="${item.url}" target="_blank" class="text-blue-600 hover:underline text-sm" aria-label="Ver grabaci√≥n">üîó Ver</a>
              <a href="${item.url}" download="${item.nombre}" class="text-green-600 hover:underline text-sm" aria-label="Descargar grabaci√≥n">‚¨áÔ∏è Descargar</a>
            </div>
          `;
          lista.appendChild(li);
        });
      }

      function borrarHistorialConfirm() {
        localStorage.removeItem("grabaciones");
        mostrarHistorial();
        showAlert("El historial ha sido borrado.");
      }
    </script>
  </body>
</html>
