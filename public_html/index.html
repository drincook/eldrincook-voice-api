<!DOCTYPE html>
<html lang="es">
  <head>
    <title>Grabadora de Voz - EldrinCook</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      #status {
        padding: 10px;
        margin-top: 10px;
        font-weight: bold;
        transition: all 0.3s ease;
      }
      #status.loading {
        color: #ffaa00;
      }
      #status.success {
        color: #28a745;
        animation: pulse 0.6s ease;
      }
      #status.error {
        color: #dc3545;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body>
    <h1>üéôÔ∏è Graba tu voz para el podcast</h1>

    <label for="nombre">üìõ Nombre de la grabaci√≥n:</label>
    <input type="text" id="nombre" placeholder="ej: capitulo-intro" />
    <br /><br />

    <p id="status" class="loading">üîÑ Cargando servidor...</p>
    <button id="start" disabled>Comenzar Grabaci√≥n</button>
    <button id="stop" disabled>Detener</button>
    <audio id="audio" controls></audio>

    <!-- üîä Sonido de √©xito -->
    <audio
      id="success-sound"
      src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_3cf9ccf3ca.mp3"
      preload="auto"
    ></audio>

    <script>
      let mediaRecorder;
      let audioChunks = [];

      const status = document.getElementById("status");
      const startBtn = document.getElementById("start");
      const stopBtn = document.getElementById("stop");
      const inputNombre = document.getElementById("nombre");
      const successSound = document.getElementById("success-sound");

      async function pingBackend() {
        try {
          await fetch("https://eldrincook-voice-api.onrender.com/files");
          status.textContent = "‚úÖ Servidor activo. Puedes grabar tu voz.";
          status.className = "success";
          startBtn.disabled = false;
        } catch (err) {
          status.textContent = "‚ö†Ô∏è El servidor est√° tardando en responder...";
          status.className = "error";
        }
      }

      window.addEventListener("DOMContentLoaded", pingBackend);

      startBtn.onclick = async () => {
        await pingBackend();

        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });

        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();

        audioChunks = [];
        mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);

        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: "audio/webm" });
          const audioURL = URL.createObjectURL(blob);
          document.getElementById("audio").src = audioURL;

          const nombreLimpio = inputNombre.value.trim();
          const nombreArchivo =
            nombreLimpio !== ""
              ? nombreLimpio.replace(/\s+/g, "_")
              : `grabacion-${Date.now()}`;

          const formData = new FormData();
          formData.append("audio", blob, `${nombreArchivo}.webm`);
          formData.append("nombrePersonalizado", nombreArchivo);

          try {
            const response = await fetch(
              "https://eldrincook-voice-api.onrender.com/upload",
              {
                method: "POST",
                body: formData,
                credentials: "include",
              }
            );

            const result = await response.json();
            console.log("‚úÖ Subido:", result);

            // ‚úÖ Mensaje visual + animaci√≥n
            status.innerHTML = `
              ‚úÖ Grabaci√≥n enviada como: <strong>${result.nombre}</strong><br>
              <a href="${result.googleDriveUrl}" target="_blank">‚¨áÔ∏è Descargar MP3</a>
            `;
            status.className = "success";

            // üîä Sonido de √©xito
            successSound.play();

            // üíæ Descargar autom√°ticamente
            const a = document.createElement("a");
            a.href = result.googleDriveUrl;
            a.download = result.nombre || "grabacion.mp3";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          } catch (err) {
            console.error("‚ùå Error al subir:", err);
            status.textContent = "‚ùå Error al subir la grabaci√≥n.";
            status.className = "error";
            alert("Hubo un error al subir tu grabaci√≥n.");
          }
        };

        stopBtn.disabled = false;
      };

      stopBtn.onclick = () => {
        mediaRecorder.stop();
        stopBtn.disabled = true;
      };
    </script>
  </body>
</html>
