<!DOCTYPE html>
<html lang="es">
  <head>
    <title>Grabadora de Voz - EldrinCook</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f0f2f5;
        color: #333;
        min-height: 100vh;
        box-sizing: border-box;
      }
      button:focus,
      input:focus {
        outline: 2px solid #2563eb; /* Tailwind blue-600 */
        outline-offset: 2px;
      }
      /* Custom scrollbar for historial */
      #historial {
        scrollbar-width: thin;
        scrollbar-color: #2563eb #f0f2f5;
      }
      #historial::-webkit-scrollbar {
        height: 8px;
        width: 8px;
      }
      #historial::-webkit-scrollbar-thumb {
        background: #2563eb;
        border-radius: 10px;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #fff;
        border-radius: 1rem;
        padding: 2rem 1rem;
        max-width: 95vw;
        width: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      }
      @media (max-width: 640px) {
        .modal-content {
          padding: 1rem 0.5rem;
        }
      }
      @media (max-width: 500px) {
        h1,
        h2 {
          font-size: 1.2rem !important;
        }
      }
    </style>
  </head>
  <body>
    <main class="flex flex-col items-center w-full min-h-screen px-2 sm:px-0">
      <section
        class="w-full sm:w-[95%] md:w-[75%] max-w-xl mt-6 bg-white rounded-2xl shadow-lg p-4 sm:p-8 flex flex-col items-center"
      >
        <h1 class="text-2xl sm:text-3xl font-extrabold mb-4 text-center">
          üéôÔ∏è Graba tu voz para el podcast
        </h1>
        <form
          id="grabacionForm"
          class="w-full flex flex-col gap-2"
          autocomplete="off"
          onsubmit="return false;"
        >
          <label for="nombre" class="font-semibold text-gray-700"
            >üìõ Nombre de la grabaci√≥n:</label
          >
          <input
            type="text"
            id="nombre"
            placeholder="ej: capitulo-intro"
            class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
            autocomplete="off"
          />
        </form>
        <p
          id="status"
          class="w-full rounded-lg px-3 py-2 mt-3 font-semibold text-center bg-yellow-50 text-yellow-800 border border-yellow-400 transition"
          role="status"
          aria-live="polite"
        >
          üîÑ Cargando servidor...
        </p>
        <div
          id="recording-indicator"
          class="flex items-center justify-center mt-2"
          style="display: none"
        >
          <span
            id="recording-dot"
            class="w-3 h-3 bg-red-600 rounded-full animate-pulse mr-2"
          ></span>
          <span id="recording-timer" class="font-mono"></span>
        </div>
        <div class="flex flex-col xs:flex-row gap-2 mt-4 w-full">
          <button
            id="start"
            type="button"
            class="flex-1 bg-green-600 hover:bg-green-700 transition text-white font-bold py-2 rounded-lg shadow disabled:opacity-60 disabled:cursor-not-allowed"
            disabled
            aria-label="Comenzar Grabaci√≥n"
          >
            Comenzar Grabaci√≥n
          </button>
          <button
            id="stop"
            type="button"
            class="flex-1 bg-red-600 hover:bg-red-700 transition text-white font-bold py-2 rounded-lg shadow disabled:opacity-60 disabled:cursor-not-allowed"
            disabled
            aria-label="Detener Grabaci√≥n"
          >
            Detener
          </button>
        </div>
        <div id="audio-player-container" class="w-full mt-4">
          <audio id="audio" controls class="w-full rounded-lg"></audio>
        </div>
      </section>
      <audio
        id="success-sound"
        src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_3cf9ccf3ca.mp3"
        preload="auto"
        aria-hidden="true"
      ></audio>
      <section
        class="w-full sm:w-[95%] md:w-[75%] max-w-xl mt-8 bg-white rounded-2xl shadow-lg p-4 sm:p-8 flex flex-col items-center"
      >
        <h2 class="text-xl sm:text-2xl font-bold mb-3 text-center">
          üïò Historial de Grabaciones
        </h2>
        <ul id="historial" class="w-full max-h-60 overflow-y-auto mb-3"></ul>
        <button
          class="borrar bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg font-semibold mt-2 transition shadow"
          type="button"
          onclick="showConfirmModal('¬øEst√°s seguro de que quieres borrar todo el historial?', borrarHistorialConfirm)"
        >
          üóëÔ∏è Borrar historial
        </button>
      </section>
    </main>
    <div
      id="customModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modalTitle"
    >
      <div class="modal-content">
        <h3 id="modalTitle" class="text-xl font-bold mb-2"></h3>
        <p id="modalMessage" class="mb-4"></p>
        <div class="modal-buttons flex justify-center gap-4">
          <button
            id="modalConfirmBtn"
            class="confirm-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg px-4 py-2 transition"
            type="button"
          >
            Aceptar
          </button>
          <button
            id="modalCancelBtn"
            class="cancel-btn bg-gray-400 hover:bg-gray-600 text-white font-semibold rounded-lg px-4 py-2 transition"
            type="button"
            style="display: none"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>
    <script>
      let mediaRecorder;
      let audioChunks = [];
      let recordingTimerInterval;
      let recordingStartTime;

      const status = document.getElementById("status");
      const startBtn = document.getElementById("start");
      const stopBtn = document.getElementById("stop");
      const inputNombre = document.getElementById("nombre");
      const successSound = document.getElementById("success-sound");
      const recordingIndicator = document.getElementById("recording-indicator");
      const recordingTimer = document.getElementById("recording-timer");

      // Modal references
      const customModal = document.getElementById("customModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalMessage = document.getElementById("modalMessage");
      const modalConfirmBtn = document.getElementById("modalConfirmBtn");
      const modalCancelBtn = document.getElementById("modalCancelBtn");

      // Modal helpers
      function showModal(
        title,
        message,
        isConfirm = false,
        onConfirm = null,
        onCancel = null
      ) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        customModal.style.display = "flex";
        modalCancelBtn.style.display = isConfirm ? "inline-block" : "none";
        modalConfirmBtn.onclick = () => {
          customModal.style.display = "none";
          if (onConfirm) onConfirm();
        };
        modalCancelBtn.onclick = isConfirm
          ? () => {
              customModal.style.display = "none";
              if (onCancel) onCancel();
            }
          : null;
      }
      function showAlert(message) {
        showModal("Atenci√≥n", message);
      }
      function showConfirmModal(message, onConfirm, onCancel = null) {
        showModal("Confirmaci√≥n", message, true, onConfirm, onCancel);
      }

      // Timer
      function updateRecordingTimer() {
        const elapsedTime = Date.now() - recordingStartTime;
        const seconds = Math.floor((elapsedTime / 1000) % 60);
        const minutes = Math.floor(elapsedTime / 1000 / 60);
        recordingTimer.textContent = `${String(minutes).padStart(
          2,
          "0"
        )}:${String(seconds).padStart(2, "0")}`;
      }

      async function pingBackend() {
        try {
          await fetch("https://eldrincook-voice-api.onrender.com/files");
          status.textContent = "‚úÖ Servidor activo. Puedes grabar tu voz.";
          status.className = "bg-green-50 text-green-800 border-green-400";
          startBtn.disabled = false;
        } catch (err) {
          status.textContent = "‚ö†Ô∏è El servidor est√° tardando en responder...";
          status.className = "bg-red-50 text-red-800 border-red-400";
          showAlert(
            "El servidor est√° tardando en responder. Por favor, int√©ntalo de nuevo m√°s tarde."
          );
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        pingBackend();
        mostrarHistorial();
      });

      inputNombre.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          startBtn.click();
        }
      });

      startBtn.onclick = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();

          audioChunks = [];
          mediaRecorder.ondataavailable = (event) =>
            audioChunks.push(event.data);

          recordingStartTime = Date.now();
          recordingTimer.textContent = "00:00";
          recordingIndicator.style.display = "flex";
          recordingTimerInterval = setInterval(updateRecordingTimer, 1000);

          status.textContent = "üî¥ Grabando...";
          status.className = "bg-blue-50 text-blue-800 border-blue-400";
          startBtn.disabled = true;
          stopBtn.disabled = false;
          stopBtn.focus();

          mediaRecorder.onstop = async () => {
            clearInterval(recordingTimerInterval);
            recordingIndicator.style.display = "none";

            const blob = new Blob(audioChunks, { type: "audio/webm" });
            document.getElementById("audio").src = URL.createObjectURL(blob);

            let nombreLimpio = inputNombre.value
              .trim()
              .replace(/\s+/g, "_")
              .replace(/\.(webm|mp3)$/i, "");
            if (!nombreLimpio) nombreLimpio = `grabacion-${Date.now()}`;
            const formData = new FormData();
            formData.append("audio", blob, `${nombreLimpio}.webm`);
            formData.append("nombrePersonalizado", nombreLimpio);

            status.textContent = "‚¨ÜÔ∏è Subiendo y convirtiendo...";
            status.className = "bg-yellow-50 text-yellow-800 border-yellow-400";

            try {
              const response = await fetch(
                "https://eldrincook-voice-api.onrender.com/upload",
                {
                  method: "POST",
                  body: formData,
                  credentials: "include",
                }
              );
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(
                  `Error del servidor: ${response.status} - ${errorText}`
                );
              }
              const result = await response.json();
              status.innerHTML = `
                ‚úÖ Grabaci√≥n enviada como: <strong>${result.nombre}</strong><br>
                <a href="${result.googleDriveUrl}" target="_blank" class="text-blue-600 underline">‚¨áÔ∏è Descargar MP3</a>
              `;
              status.className = "bg-green-50 text-green-800 border-green-400";
              successSound.play();

              // Descarga autom√°tica accesible
              const a = document.createElement("a");
              a.href = result.googleDriveUrl;
              a.download = result.nombre || "grabacion.mp3";
              a.style.display = "none";
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);

              guardarEnHistorial(result.nombre, result.googleDriveUrl);
            } catch (err) {
              console.error("‚ùå Error al subir:", err);
              status.textContent = "‚ùå Error al subir la grabaci√≥n.";
              status.className = "bg-red-50 text-red-800 border-red-400";
              showAlert("Hubo un error al subir tu grabaci√≥n: " + err.message);
            } finally {
              startBtn.disabled = false;
            }
          };
        } catch (err) {
          console.error("‚ùå Error al acceder al micr√≥fono:", err);
          status.textContent = "‚ùå Error: No se pudo acceder al micr√≥fono.";
          status.className = "bg-red-50 text-red-800 border-red-400";
          showAlert(
            "No se pudo acceder al micr√≥fono. Por favor, aseg√∫rate de que los permisos est√©n concedidos."
          );
          startBtn.disabled = false;
        }
      };

      stopBtn.onclick = () => {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
          stopBtn.disabled = true;
          startBtn.disabled = false;
          startBtn.focus();
        }
      };
      function guardarEnHistorial(nombre, googleDriveUrl, playbackUrl) {
        const historial = JSON.parse(localStorage.getItem("grabaciones")) || [];
        const nueva = {
          nombre: nombre,
          googleDriveUrl: googleDriveUrl, // URL para descarga
          playbackUrl: playbackUrl, // URL para reproducci√≥n
          fecha: new Date().toLocaleString("es-ES"),
        };
        historial.unshift(nueva);
        localStorage.setItem("grabaciones", JSON.stringify(historial));
        mostrarHistorial();
      }
      /*function guardarEnHistorial(nombre, url) {
        const historial = JSON.parse(localStorage.getItem("grabaciones")) || [];
        const nueva = {
          nombre,
          url,
          fecha: new Date().toLocaleString("es-ES"),
        };
        historial.unshift(nueva);
        localStorage.setItem("grabaciones", JSON.stringify(historial));
        mostrarHistorial();
      }*/
      function mostrarHistorial() {
        const historial = JSON.parse(localStorage.getItem("grabaciones")) || [];
        const lista = document.getElementById("historial");
        lista.innerHTML = "";
        if (historial.length === 0) {
          lista.innerHTML =
            '<li class="text-gray-500">A√∫n no has grabado nada.</li>';
          return;
        }
        historial.forEach((item) => {
          const li = document.createElement("li");
          li.className =
            "flex flex-col sm:flex-row sm:items-center justify-between gap-2 p-2 bg-gray-50 rounded-lg mb-2 border";
          li.innerHTML = `
            <div class="flex-grow truncate">
              üìÅ <strong>${item.nombre}</strong> - <span class="text-sm text-gray-600">${item.fecha}</span>
            </div>
            <div class="flex items-center gap-2 mt-2 sm:mt-0">
							
              <audio controls src="${item.playbackUrl}" class="h-8" aria-label="Reproducir grabaci√≥n ${item.nombre}"></audio>
              <a href="${item.url}" target="_blank" class="text-blue-600 underline text-sm" aria-label="Ver grabaci√≥n">üîó Ver</a>
              <a href="${item.url}" download="${item.nombre}" class="text-green-600 underline text-sm" aria-label="Descargar grabaci√≥n">‚¨áÔ∏è Descargar</a>
            </div>
          `;
          lista.appendChild(li);
        });
      }
      function borrarHistorialConfirm() {
        localStorage.removeItem("grabaciones");
        mostrarHistorial();
        showAlert("El historial ha sido borrado.");
      }
    </script>
  </body>
</html>
